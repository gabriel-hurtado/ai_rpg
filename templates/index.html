{% extends "base.html" %}

{% block title %}Home - {{ super() }}{% endblock %}

{% block content %}

    <!-- Hero Section -->
    <section id="hero" class="d-flex align-items-center text-center py-5 px-3 text-white overflow-hidden">
        <div class="container position-relative" style="z-index: 2;">
            <div data-aos="fade-down">
                <h1 class="display-2 fw-bold mb-3">AI-Powered <span class="highlight-gradient">Homebrew</span></h1>
                <p class="lead mb-4 mx-auto fw-light" style="max-width: 650px;">Instantly generate limitless TTRPG content. Build unique worlds, compelling characters, and thrilling adventures with your AI co-creator.</p>
            </div>
            <a href="#pricing" class="btn btn-lg custom-btn custom-btn-warning shadow-lg fw-bold mt-3" data-aos="fade-up" data-aos-delay="300">
                <i class="bi bi-stars me-2"></i>Start Creating Now <i class="bi bi-chevron-right ms-1"></i>
            </a>
        </div>
        <div class="hero-shapes"></div>
    </section>

    <!-- Features Section -->
    <section id="features" class="py-5 section-bg-accent">
        <div class="container">
            <h2 class="text-center mb-5 display-5 text-white" data-aos="fade-up">Your Creative Toolkit</h2>
            <div class="row g-4 justify-content-center">
                 <div class="col-lg-4 col-md-6" data-aos="zoom-in-up" data-aos-delay="100">
                    <div class="feature-card modern-card p-4 text-center">
                        <div class="feature-icon mb-3"><i class="bi bi-brightness-high-fill"></i></div>
                        <h4 class="fw-bold mb-2">World Genesis</h4>
                        <p class="small">Craft unique settings, cultures, histories, and maps from simple prompts.</p>
                    </div>
                 </div>
                 <div class="col-lg-4 col-md-6" data-aos="zoom-in-up" data-aos-delay="250">
                     <div class="feature-card modern-card p-4 text-center">
                        <div class="feature-icon mb-3"><i class="bi bi-people-fill"></i></div>
                        <h4 class="fw-bold mb-2">Character Forge</h4>
                        <p class="small">Generate diverse NPCs & Monsters with deep personalities and motivations.</p>
                    </div>
                 </div>
                 <div class="col-lg-4 col-md-6" data-aos="zoom-in-up" data-aos-delay="400">
                     <div class="feature-card modern-card p-4 text-center">
                        <div class="feature-icon mb-3"><i class="bi bi-journal-richtext"></i></div>
                        <h4 class="fw-bold mb-2">Adventure Crafting</h4>
                        <p class="small">Design plot hooks, balanced encounters, custom items, spells, and rules.</p>
                    </div>
                 </div>
            </div>
        </div>
    </section>

    <!-- How it Works Section -->
     <section id="how-it-works" class="py-5">
        <div class="container">
             <h2 class="text-center mb-5 display-5" data-aos="fade-up">Launch Your Campaign Fast</h2>
            <div class="row text-center g-5 align-items-center">
                <div class="col-md-4" data-aos="fade-right" data-aos-delay="100">
                    <div class="step-icon mb-3"><i class="bi bi-person-plus-fill"></i></div>
                    <h4 class="fw-bold fs-5">1. Sign Up Free</h4>
                    <p class="text-muted small">Quick account creation.</p>
                </div>
                 <div class="col-md-4" data-aos="fade-up" data-aos-delay="250">
                    <div class="step-icon mb-3"><i class="bi bi-credit-card-2-front-fill"></i></div>
                    <h4 class="fw-bold fs-5">2. Get Credit</h4>
                    <p class="text-muted small">One-time €10 purchase.</p>
                </div>
                 <div class="col-md-4" data-aos="fade-left" data-aos-delay="400">
                    <div class="step-icon mb-3"><i class="bi bi-lightbulb-fill"></i></div>
                    <h4 class="fw-bold fs-5">3. Create Magic</h4>
                    <p class="text-muted small">Generate endless content.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Pricing Section -->
    <section id="pricing" class="py-5 section-bg-accent">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-6" data-aos="flip-up">
                    <div class="card pricing-card modern-card text-center border-0 overflow-hidden">
                         <div class="card-header pricing-header pt-4 pb-3 border-0">
                            <h4 class="my-0 fw-bold text-primary">Homebrew Build Credit</h4>
                        </div>
                        <div class="card-body p-4">
                            <div class="pricing-tag mb-4">
                                €10 <span class="pricing-term">/ Project</span>
                            </div>
                            <ul class="list-unstyled mt-3 mb-4 text-center small">
                                <li><i class="bi bi-check-circle text-success me-2"></i>Full AI Tool Access</li>
                                <li><i class="bi bi-check-circle text-success me-2"></i>Extensive Generation*</li>
                                <li><i class="bi bi-check-circle text-success me-2"></i>Build a Complete Homebrew</li>
                                <li><i class="bi bi-check-circle text-success me-2"></i>No Subscriptions</li>
                            </ul>
                            {# Purchase button shown/hidden by auth.js #}
                            <button type="button" class="w-100 btn btn-lg custom-btn custom-btn-primary rounded-pill purchase-button" id="purchase-button" style="display: none;"><i class="bi bi-wallet-fill me-2"></i> Unlock Builder Access</button>
                            <small class="d-block text-muted mt-3 small">*Approx. 100 AI interactions.</small>
                        </div>
                        <div class="pricing-glow"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- AI Tool Section -->
     <section id="ai-tool" class="py-5 text-center">
        <div class="container" data-aos="fade-up">
            <h2 class="mb-4 display-5">The Adventure Forge</h2>
            <div id="tool-access-area">
                {# This prompt is shown/hidden by auth.js #}
                <p class="lead text-muted mb-4">Please <a href="#" class="link-primary" id="login-link-tool-placeholder">log in</a> and purchase credit to unleash the AI.</p>

                 {# --- CHAT HISTORY AREA --- #}
                 <div id="ai-result-output" class="mb-3 text-start result-area p-3 rounded chat-container"> {# Added mb-3 for spacing #}
                      <div id="chat-message-list"> {# Inner div for messages #}
                          <p class="text-muted small text-center initial-chat-prompt">Chat history will appear here.</p>
                      </div>
                      <div id="chat-error"></div> {# For OOB error swaps #}
                 </div>

                 {# --- INPUT FORM AREA (Streaming, JS-based, not HTMX) --- #}
                 <form id="ai-generation-form"
                       class="ai-tool-form mx-auto"
                       action="/api/v1/chat/message" method="post"
                       style="max-width: 700px; display: none;">
                      <div class="d-flex align-items-center">
                          <label for="ai-prompt-input" class="form-label visually-hidden">AI Prompt</label>
                          <textarea class="form-control form-control-lg bg-light me-2" id="ai-prompt-input" name="prompt" rows="1" style="resize: none; height: auto;" placeholder="Enter your prompt here..." required disabled></textarea>
                          <button type="submit" id="ai-generate-button" class="btn btn-lg custom-btn custom-btn-secondary flex-shrink-0" disabled>
                              <i class="bi bi-magic"></i>
                          </button>
                          <div id="ai-loading-indicator" class="spinner-border spinner-border-sm ms-2" role="status" style="display:none;">
                              <span class="visually-hidden">Loading...</span>
                          </div>
                      </div>
                  </form>

            </div> {# End tool-access-area #}
        </div> {# End container #}
    </section>

{% endblock %}

{% block scripts %}
    {# Base scripts are inherited #}
    {{ super() }}

    {# Inline script specific to this page (HTMX helpers & event listeners) #}
    <script>
        console.log("Index page specific scripts loaded");

        // Helper function for HTMX to get the current access token
        function getAuthTokenForHtmx() {
            if (window.currentAccessToken) { // Reads global var set by auth.js
                return window.currentAccessToken;
            }
            console.warn("[HTMX Token Helper] No currentAccessToken found.");
            return "";
        }

        // Optional: HTMX Event Listeners
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            console.log('HTMX request finished for:', evt.detail.pathInfo.path, 'Success:', evt.detail.successful);
             // Re-enable button manually
             const generateButton = document.getElementById('ai-generate-button');
             if (generateButton) { generateButton.disabled = false; }

             if (evt.detail.failed || !evt.detail.successful) {
                console.error('HTMX request failed:', evt.detail.xhr?.status, evt.detail.xhr?.responseText);
                const errorTarget = document.getElementById('chat-error');
                // Avoid showing generic error if backend sent specific error via OOB
                if(errorTarget && !errorTarget.innerHTML.includes('alert')) {
                      errorTarget.innerHTML = `<div class="alert alert-danger mt-3 alert-dismissible fade show" role="alert">Request failed (${evt.detail.xhr?.status || 'Network Error'}). Please try again.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
                 }
            } else {
                 // If successful, reset the form (unless hx-on handles it)
                 const form = document.getElementById('ai-generation-form');
                 if (form) form.reset();
            }
        });

         document.body.addEventListener('htmx:beforeRequest', function(evt) {
            console.log('HTMX request starting for:', evt.detail.pathInfo.path);
            // Clear previous errors shown via OOB swap
             const errorTarget = document.getElementById('chat-error');
             if(errorTarget) errorTarget.innerHTML = '';
         });

    </script>
{% endblock %}